name: RuhrFinds â€“ TÃ¤gliche Automatisierung

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  daily-run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:

      - name: Repository auschecken
        uses: actions/checkout@v4

      - name: Python 3.11 einrichten
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: AbhÃ¤ngigkeiten installieren
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Google Credentials schreiben
        if: ${{ secrets.GOOGLE_CREDENTIALS_JSON != '' }}
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: echo "$GOOGLE_CREDENTIALS" > credentials.json

      - name: OSM & Events sammeln
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        run: python collector.py

      - name: Google Trends & Affiliate-Analyse
        run: python trends_affiliate.py

      - name: Ads Intelligence & SEO Keywords
        run: python ads_intelligence.py

      - name: KI-Artikel generieren
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          WP_URL:            ${{ secrets.WP_URL }}
          WP_USER:           ${{ secrets.WP_USER }}
          WP_PASSWORD:       ${{ secrets.WP_PASSWORD }}
        run: python ki_content.py

      - name: Instagram & Facebook posten
        env:
          ANTHROPIC_API_KEY:    ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
          META_ACCESS_TOKEN:    ${{ secrets.META_ACCESS_TOKEN }}
          META_IG_ACCOUNT_ID:   ${{ secrets.META_IG_ACCOUNT_ID }}
          META_FB_PAGE_ID:      ${{ secrets.META_FB_PAGE_ID }}
          META_FB_PAGE_TOKEN:   ${{ secrets.META_FB_PAGE_TOKEN }}
          WP_URL:               ${{ secrets.WP_URL }}
          WP_USER:              ${{ secrets.WP_USER }}
          WP_PASSWORD:          ${{ secrets.WP_PASSWORD }}
          DEFAULT_SOCIAL_IMAGE: ${{ secrets.DEFAULT_SOCIAL_IMAGE }}
        run: python social_publisher.py

      - name: Dashboard & Plots generieren
        run: python analyse.py

      - name: Daten committen
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/ reports/ content_log.json social_log.json || true
          git diff --staged --quiet || git commit -m "ðŸ“Š TÃ¤gliches Update $(date +%Y-%m-%d)"
          git push

      - name: Artifacts hochladen
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ruhrfinds-${{ github.run_number }}
          path: |
            output/
            reports/
          retention-days: 30
